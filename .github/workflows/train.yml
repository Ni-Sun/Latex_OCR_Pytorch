name: æ‰‹åŠ¨è®­ç»ƒå·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      dataset:
        description: 'é€‰æ‹©æ•°æ®é›†ç±»å‹'
        required: true
        type: choice
        options:
          - small
          - CROHME
          - full
          - hand
          - fullhand
        default: 'small'

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶ä¿æŠ¤
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install tqdm opencv-python numpy
      
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: |
          mkdir -p data/${{ inputs.dataset }}
          echo "ğŸ“ æ•°æ®ç›®å½•å·²åˆ›å»º: data/${{ inputs.dataset }}"
          echo "âš ï¸  æ³¨æ„: è®­ç»ƒå‰è¯·ç¡®ä¿æ•°æ®é›†æ–‡ä»¶å·²å­˜åœ¨"
          echo "   éœ€è¦çš„æ–‡ä»¶: vocab.json, train.json, val.json (æˆ– data.json)"
      
      - name: æ£€æŸ¥æ•°æ®é›†æ–‡ä»¶
        run: |
          if [ ! -f "data/${{ inputs.dataset }}/vocab.json" ]; then
            echo "âŒ é”™è¯¯: vocab.json æ–‡ä»¶ä¸å­˜åœ¨"
            echo "è¯·å…ˆä¸Šä¼ æ•°æ®é›†æ–‡ä»¶åˆ° data/${{ inputs.dataset }}/ ç›®å½•"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° vocab.json æ–‡ä»¶"
          
          if [ -f "data/${{ inputs.dataset }}/train.json" ] && [ -f "data/${{ inputs.dataset }}/val.json" ]; then
            echo "âœ… æ‰¾åˆ° train.json å’Œ val.json æ–‡ä»¶"
          elif [ -f "data/${{ inputs.dataset }}/data.json" ]; then
            echo "âœ… æ‰¾åˆ° data.json æ–‡ä»¶"
          else
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°è®­ç»ƒæ•°æ®æ–‡ä»¶ (train.json/val.json æˆ– data.json)"
            exit 1
          fi
      
      - name: è®­ç»ƒæ¨¡å‹
        run: |
          echo "å¼€å§‹è®­ç»ƒï¼Œä½¿ç”¨æ•°æ®é›†: ${{ inputs.dataset }}"
          python train.py --data_name ${{ inputs.dataset }}
        continue-on-error: true
      
      - name: ä¸Šä¼ æ¨¡å‹æ£€æŸ¥ç‚¹
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: model-checkpoint-${{ inputs.dataset }}-${{ github.run_number }}
          path: |
            checkpoint_${{ inputs.dataset }}.pth.tar
            BEST_checkpoint_${{ inputs.dataset }}.pth.tar
          retention-days: 30
          if-no-files-found: warn
      
      - name: è®­ç»ƒå®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… è®­ç»ƒæˆåŠŸå®Œæˆï¼"
          echo "æ•°æ®é›†: ${{ inputs.dataset }}"
          echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
